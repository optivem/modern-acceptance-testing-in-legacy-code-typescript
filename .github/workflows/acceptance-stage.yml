name: acceptance-stage

on:
  schedule:
    - cron: '*/30 * * * *'  # Run every 30 minutes
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run (even if no new images)'
        required: false
        default: false
        type: boolean

jobs:

  find-latest-images:
    runs-on: ubuntu-latest
    outputs:
      image-digest-urls: ${{ steps.get-digest.outputs.image-digest-urls }}
      latest-image-timestamp: ${{ steps.get-digest.outputs.latest-image-timestamp }}

    permissions:
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Resolve Latest Docker Digests
        id: get-digest
        uses: optivem/find-latest-docker-images-action@v1
        with:
          image-urls: |
            ghcr.io/${{ github.repository_owner }}/modern-acceptance-testing-in-legacy-code/frontend:latest
            ghcr.io/${{ github.repository_owner }}/modern-acceptance-testing-in-legacy-code/backend:latest

  should-run:
    needs: find-latest-images
    if: needs.find-latest-images.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Should Run Acceptance Stage
        id: check
        uses: optivem/should-run-acceptance-stage-action@v1
        with:
          latest-image-timestamp: ${{ needs.find-latest-images.outputs.latest-image-timestamp }}
          force-run: ${{ inputs.force_run == true }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  system-test:
    needs: [ should-run, find-latest-images ]
    if: needs.should-run.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy System (Real External Systems)
        uses: ./.github/actions/deploy-docker-images
        with:
          environment: acceptance
          version: latest
          image-urls: ${{ needs.find-latest-images.outputs.image-digest-urls }}
          external-system-mode: 'real'
          frontend-url: 'http://localhost:3001/'
          backend-url: 'http://localhost:8081/health'
          erp-url: 'http://localhost:9001/erp/health'
          tax-url: 'http://localhost:9001/tax/health'

      - name: Deploy System (Stub External Systems)
        uses: ./.github/actions/deploy-docker-images
        with:
          environment: acceptance
          version: latest
          image-urls: ${{ needs.find-latest-images.outputs.image-digest-urls }}
          external-system-mode: 'stub'
          frontend-url: 'http://localhost:3002/'
          backend-url: 'http://localhost:8082/health'
          erp-url: 'http://localhost:9002/erp/health'
          tax-url: 'http://localhost:9002/tax/health'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Project
        run: npm run build

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium
        working-directory: system-test

      - name: Run Acceptance Tests - API Channel
        run: npx cross-env ENVIRONMENT=acceptance EXTERNAL_SYSTEM_MODE=STUB CHANNEL=API npm test -- tests/acceptance-tests
        working-directory: system-test

      - name: Run Acceptance Tests - UI Channel
        run: npx cross-env ENVIRONMENT=acceptance EXTERNAL_SYSTEM_MODE=STUB CHANNEL=UI npm test -- tests/acceptance-tests
        working-directory: system-test

      # - name: Run Acceptance Tests (Isolated) - API Channel
      #   run: npx cross-env ENVIRONMENT=acceptance EXTERNAL_SYSTEM_MODE=STUB CHANNEL=API npm test -- tests/acceptance-tests --grep "@isolated"
      #   working-directory: system-test

      # - name: Run Acceptance Tests (Isolated) - UI Channel
      #   run: npx cross-env ENVIRONMENT=acceptance EXTERNAL_SYSTEM_MODE=STUB CHANNEL=UI npm test -- tests/acceptance-tests --grep "@isolated"
      #   working-directory: system-test

      # - name: Run External System Contract Tests (Stubbed External Systems)
      #   run: npx cross-env ENVIRONMENT=acceptance EXTERNAL_SYSTEM_MODE=STUB npm test -- tests/external-system-contract-tests
      #   working-directory: system-test

      # - name: Run External System Contract Tests (Real External Systems)
      #   run: npx cross-env ENVIRONMENT=acceptance EXTERNAL_SYSTEM_MODE=REAL npm test -- tests/external-system-contract-tests
      #   working-directory: system-test

      - name: Run E2E Tests - API Channel
        run: npx cross-env ENVIRONMENT=acceptance EXTERNAL_SYSTEM_MODE=REAL CHANNEL=API npm test -- tests/e2e-tests
        working-directory: system-test

      - name: Run E2E Tests - UI Channel
        run: npx cross-env ENVIRONMENT=acceptance EXTERNAL_SYSTEM_MODE=REAL CHANNEL=UI npm test -- tests/e2e-tests
        working-directory: system-test