name: acceptance-stage

on:
  schedule:
    - cron: '*/30 * * * *'  # Run every 30 minutes
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run (even if no new images)'
        required: false
        default: false
        type: boolean

concurrency:
  group: acceptance-stage
  cancel-in-progress: true

jobs:

  find-latest-images:
    runs-on: ubuntu-latest
    outputs:
      image-digest-urls: ${{ steps.get-digest.outputs.image-digest-urls }}
      latest-image-timestamp: ${{ steps.get-digest.outputs.latest-image-timestamp }}

    permissions:
      contents: read

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Resolve Latest Docker Digests
      id: get-digest
      uses: optivem/find-latest-docker-images-action@v1
      with:
        image-urls: |
          ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}/monolith:latest

  should-run:
    needs: find-latest-images
    if: needs.find-latest-images.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Should Run Acceptance Stage
        id: check
        uses: optivem/should-run-acceptance-stage-action@v1
        with:
          latest-image-timestamp: ${{ needs.find-latest-images.outputs.latest-image-timestamp }}
          force-run: ${{ inputs.force_run == true }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  system-test:
    needs: [should-run, find-latest-images]
    if: needs.should-run.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Deploy System
      id: deploy-system
      uses: ./.github/actions/deploy-docker-images
      with:
        environment: acceptance
        version: latest
        image-urls: ${{ needs.find-latest-images.outputs.image-digest-urls }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Test Dependencies
      run: npm ci

    - name: Build Workspace Packages
      run: |
        echo "Building optivem-results..."
        npm run build -w optivem-results
        ls -la optivem-results/dist/ || echo "No dist folder for optivem-results"
        
        echo "Building optivem-lang..."
        npm run build -w optivem-lang
        ls -la optivem-lang/dist/ || echo "No dist folder for optivem-lang"
        
        echo "Building optivem-http..."
        npm run build -w optivem-http
        ls -la optivem-http/dist/ || echo "No dist folder for optivem-http"
        
        echo "Building optivem-playwright..."
        npm run build -w optivem-playwright
        ls -la optivem-playwright/dist/ || echo "No dist folder for optivem-playwright"
        
        echo "Building optivem-testing-channels..."
        npm run build -w optivem-testing-channels
        ls -la optivem-testing-channels/dist/ || echo "No dist folder for optivem-testing-channels"
        
        echo "Building optivem-testing-assertions..."
        npm run build -w optivem-testing-assertions
        ls -la optivem-testing-assertions/dist/ || echo "No dist folder for optivem-testing-assertions"
        
        echo "Checking node_modules symlinks..."
        ls -la node_modules/@optivem/testing-channels/dist/ || echo "No dist in node_modules symlink"

    - name: Install Playwright Browsers
      working-directory: system-test
      run: npx playwright install

    - name: Run Acceptance Tests
      run: echo "Run Acceptance Tests"

    - name: Run External System Contract Tests
      run: echo "Run External System Contract Tests"

    - name: Run E2E Tests
      working-directory: system-test
      run: npm test -- tests/e2e-tests