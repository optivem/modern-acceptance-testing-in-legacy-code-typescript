name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install root dependencies
      run: npm install
    
    - name: Install monolith dependencies
      working-directory: ./monolith
      run: npm install
    
    - name: Build monolith
      working-directory: ./monolith
      run: npm run build
    
    - name: Install system-test dependencies
      working-directory: ./system-test
      run: npm install
    
    - name: Install Playwright Browsers
      working-directory: ./system-test
      run: npx playwright install --with-deps chromium
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: monolith-dist
        path: monolith/dist/
        retention-days: 1

  test:
    runs-on: ubuntu-latest
    needs: build
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: eshop
          POSTGRES_USER: eshop_user
          POSTGRES_PASSWORD: eshop_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: monolith-dist
        path: monolith/dist/
    
    - name: Start mock APIs
      run: |
        docker-compose -f docker-compose.pipeline.yml up -d erp-api tax-api
        sleep 5
    
    - name: Install monolith dependencies
      working-directory: ./monolith
      run: npm install --production
    
    - name: Start monolith application
      working-directory: ./monolith
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: eshop
        DB_USER: eshop_user
        DB_PASSWORD: eshop_password
        ERP_API_URL: http://localhost:3000
        TAX_API_URL: http://localhost:3001
      run: |
        npm start &
        echo $! > app.pid
        sleep 10
    
    - name: Wait for application to be ready
      run: |
        for i in {1..30}; do
          if curl -f http://localhost:8080/api/echo; then
            echo "Application is ready"
            exit 0
          fi
          echo "Waiting for application..."
          sleep 2
        done
        echo "Application failed to start"
        exit 1
    
    - name: Install system-test dependencies
      working-directory: ./system-test
      run: npm install
    
    - name: Install Playwright Browsers
      working-directory: ./system-test
      run: npx playwright install --with-deps chromium
    
    - name: Run Playwright tests
      working-directory: ./system-test
      env:
        CI: true
      run: npm test
    
    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: system-test/playwright-report/
        retention-days: 30
    
    - name: Stop application
      if: always()
      run: |
        if [ -f monolith/app.pid ]; then
          kill $(cat monolith/app.pid) || true
        fi
    
    - name: Stop Docker services
      if: always()
      run: docker-compose -f docker-compose.pipeline.yml down

  docker-build:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Build monolith
      working-directory: ./monolith
      run: |
        npm install
        npm run build
    
    - name: Build Docker image
      run: docker build -t eshop-monolith:latest ./monolith
    
    - name: Save Docker image
      run: docker save eshop-monolith:latest | gzip > eshop-monolith.tar.gz
    
    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: eshop-monolith.tar.gz
        retention-days: 7
